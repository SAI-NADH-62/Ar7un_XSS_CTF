<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reflected — XSS CTF (Safe Version)</title>
  <link rel="stylesheet" href="/assets/style.css">
  <style>
    main { max-width:900px; margin:2rem auto; padding:1rem; }
    .vuln-box { background: rgba(255,255,255,0.02); padding:1rem; border-radius:10px; border:1px solid rgba(255,255,255,0.03); }
    .input-row { display:flex; gap:8px; margin:0.75rem 0; align-items:center; }
    input.msg { flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; }
    button.go { padding:8px 12px; border-radius:8px; border:none; background: linear-gradient(90deg,#e11d48,#ff6b8a); color:#fff; font-weight:600; }
    .hint { color: #9aa6b2; font-size:0.9rem; margin-top:0.6rem; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand"><strong>XSS</strong> CTF <span class="tag">reflected</span></div>
      <nav class="top-nav"><a href="/index.html">Home</a></nav>
    </div>
  </header>

  <main>
    <div class="container">
      <h1>Reflected XSS (Safe Version)</h1>
      <p class="lead">
        This version of the Reflected XSS lab demonstrates how to properly escape user input
        to prevent script execution. Try typing HTML or JavaScript — it will render safely as text.
      </p>

      <div class="vuln-box">
        <div class="input-row">
          <input id="payload" class="msg" placeholder='Hello, I am Iron Man' />
          <button id="apply" class="go">Apply</button>
        </div>

        <div id="msg">Message: <em>nothing yet</em></div>
        <div class="hint">Input will be reflected safely without executing scripts.</div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>CTF lab - intentional vulnerabilities only (safe version)</small>
    </div>
  </footer>

  <script>
    const input = document.getElementById('payload');
    const applyBtn = document.getElementById('apply');
    const container = document.getElementById('msg');

    // Safely update URL parameter
    function updateUrlMsg(value) {
      const newSearch = value ? '?msg=' + encodeURIComponent(value) : '';
      const newUrl = location.pathname + newSearch + location.hash;
      history.replaceState(null, '', newUrl);
    }

    // Secure message renderer (no innerHTML)
    function injectMessage(value) {
      container.textContent = '';
      const label = document.createElement('span');
      label.textContent = 'Message: ';
      container.appendChild(label);

      if (!value) {
        const em = document.createElement('em');
        em.textContent = 'nothing yet';
        container.appendChild(em);
      } else {
        const span = document.createElement('span');
        span.className = 'user-msg';
        span.textContent = value; // textContent ensures safe rendering
        container.appendChild(span);
      }
    }

    // Initialize from URL (?msg=)
    (function initFromUrl() {
      const params = new URLSearchParams(location.search);
      const msg = params.get('msg') || '';
      if (msg) {
        input.value = msg;
        injectMessage(msg);
      } else {
        injectMessage('');
      }
    })();

    // Live update (debounced)
    let debounceTimer = null;
    input.addEventListener('input', (e) => {
      const val = e.target.value;
      updateUrlMsg(val);
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=> injectMessage(val), 120);
    });

    applyBtn.addEventListener('click', ()=> {
      const val = input.value;
      updateUrlMsg(val);
      injectMessage(val);
      input.focus();
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyBtn.click();
      }
    });
  </script>
</body>
</html>
